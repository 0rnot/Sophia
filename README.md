# Sophia - あなたの部屋のAIアシスタントDiscord Bot

## 概要
Sophiaは、Discordサーバー上で動作する多機能AIアシスタントボットです。Google Gemini AIとの連携により高度なチャット機能を提供し、ユーザーとの自然な会話を実現します。また、RPG要素、音楽再生、スマートホームデバイス（SwitchBot）との連携による環境監視、ニュースフィード監視、自発的な会話開始など、様々なユニークな機能でDiscordサーバーの体験を豊かにします。

## 機能一覧

### 1. AIチャット機能
*   **Google Gemini AI連携**: 最新のGeminiモデル（デフォルトはgemini-2.5-flash）を活用し、文脈を理解した自然で流暢な会話が可能です。`/switch_model` コマンドでAIモデルを動的に切り替えることもできます。
*   **キャラクター設定**: 親密で好奇心旺盛な女の子「ソフィア」として、ユーザーとのインタラクションを深めます。開発者（オーナー）と一般ユーザーで異なる応答ルールが適用されます。
*   **画像認識**: 添付された画像を認識し、それに基づいた会話や情報提供が可能です。
*   **会話履歴の保持**: チャンネルごとの会話履歴を保持し、より連続性のある対話を実現します。
*   **AI応答の重複修正**: AIが同じ応答を繰り返す問題を自動的に検出し、修正します。
*   **システムからのAI応答トリガー**: 環境監視などのシステムイベントに基づいて、AIが自動的にチャンネルにメッセージを投稿する機能も備えています。

### 2. RPG機能
*   **本格的なRPGシステム**: 敵との戦闘、レベルアップ、ステータス成長、アイテム収集、装備システム、アイテム売却、効果の再抽選など、本格的なRPG体験をDiscord上で提供します。
*   **多様な敵**: `enemy/` ディレクトリにJSON形式で定義された多様な敵キャラクターが登場します。
*   **レベルアップとアイテムドロップ**
    - サーバーでメッセージを送信すると経験値が溜まってレベルアップ！
    - レベルアップすると、新しい装備アイテムが手に入ることがあるよ。
    - アイテムには「武器」と「防具」があって、「ベース」と「効果」にそれぞれレアリティがあるんだ。
      組み合わせで強い効果のアイテムをゲットしよう！(最レアは0.0001%)
    - インベントリは上限があるから気をつけてね！
      いっぱいだと新しいアイテムをどうするか聞かれるよ。
*   **ステータス**
    - **HP（体力）**: レベルに応じて増えるよ。(レベル + 10)
    - **ATK (攻撃力)**: 装備してる武器と防具のATK合計値だよ。
    - **DEF (防御力)**: 装備してる武器と防具のDEF合計値だよ。
*   **戦闘**
    - `/vbattle`で始まるよ！敵の強さは色々！
    - **攻撃**: あなたのATKから敵のDEFを引いた分がダメージ！(被ダメも同様)
    - **防御**: あなたのDEFの1割ぶん、HPが回復するよ！
    - **逃走**: 戦いから逃げることもできるけど、何も手に入らないよ。
    - 敵を倒すとゴールドが手に入ることがあるよ！
*   **ガチャ機能**: `/vgacha` コマンドでゴールドを消費してアイテムガチャを引くことができます。
*   **確率と売値**
    - common:      33.9% / 500G
    - uncommon:  30%   / 1000G
    - rare:               20%   / 2500G
    - epic:               10%   / 5000G
    - legendary:     5%    / 10000G
    - mythic:           1%    / 15000G
    - unique:         0.1%  / 50000G
*   **データ永続化**: ユーザーのRPGデータ（レベル、ゴールド、インベントリ、装備）はSQLiteデータベース (`sophia_database.db`) に保存され、継続的なプレイが可能です。
*   **開発者向けデータリセット**: `/vreset_rpg` コマンドでRPGデータを完全にリセットできます（開発者専用）。

### 3. オーディオ機能
*   **YouTube/Spotifyからの音楽再生**: YouTubeのURLやSpotifyのトラック/プレイリストURL、または曲名検索で、ボイスチャンネルで音楽を再生できます。
*   **プレイリスト/キュー管理**: 再生キューに複数の曲を追加し、管理できます。プレイリストの一括追加や、曲の割り込み再生も可能です。
*   **再生コントロール**: 再生、一時停止、スキップ、停止、キューのクリア、曲/キューのループ、音量調整などの基本的なコントロールが可能です。
*   **チャットからのランダム再生**: 指定したテキストチャンネルの履歴からランダムにURLを抽出し、音楽を再生できます。

### 4. 環境監視機能 (SwitchBot連携)
*   **スマートホーム連携**: SwitchBotデバイス（温湿度計、CO2センサー、プラグミニなど）と連携し、部屋の環境データ（温度、湿度、CO2濃度、電力消費量）をリアルタイムで監視します。
*   **自動通知**: 設定された閾値（危険、注意、正常など）を超えた場合、Discordチャンネルに自動で通知を送信します。状態の変化（上昇、低下、悪化、改善、正常化）に応じて詳細なメッセージが生成されます。
*   **AIによる警告通知**: 特に危険な状態（HH: 極めて危険、LL: 極めて危険）に達した場合、AIが状況を判断し、より詳細な警告メッセージを自動で投稿します。
*   **初回起動通知**: ボット起動時に環境監視が開始されたことを通知します。
*   **コマンドによる確認**: `/hv meter` コマンドで現在の温湿度・CO2濃度を、`/hv plug` コマンドで電力消費量をいつでも確認できます。

### 5. 自発会話機能
*   **定期的な会話開始**: 1日1回、ランダムな時刻にAIが自発的に会話のきっかけとなる独り言や問いかけをDiscordチャンネルに投稿します。
*   **最もアクティブなチャンネルへの投稿**: 各サーバーで直近のメッセージ履歴を分析し、最も活発なテキストチャンネルを選んで投稿します。
*   **多様なトピック**: 日常の挨拶、雑学、個人的な興味、軽い悩み、もしもの話など、幅広いトピックで会話を促します。

### 6. フィード監視機能
*   **RSS/Atomフィード監視**: 設定されたRSS/Atomフィードを定期的に監視し、新着記事をDiscordチャンネルに通知します。
*   **デフォルトソースの自動設定**: ボットが参加したサーバーで、通知可能なチャンネルがあれば、Google Newsをベースとしたデフォルトのフィードソース（テクノロジー、AI、PCハードウェア、PCゲームなど）を自動で設定します。
*   **AIによるコメント**: 新着記事に対してAIが独自のコメントを生成し、より魅力的な通知を行います。
*   **OGP画像の取得**: 記事のURLからOGP画像（サムネイル）を自動で取得し、通知に表示します。
*   **フィードタイプの自動判別**: 追加するフィードURLがRSS形式かAtom形式かを自動で判別します。
*   **エラー処理**: 404エラーなど、取得に失敗したフィードは一時的に監視を停止し、エラーログを出力します。
*   **コマンド**: `/q add` で新しいフィードソースを追加、`/q list` で監視中のソース一覧を表示、`/q remove` でソースを削除できます。

### 7. ログ機能
*   **詳細なログ出力**: ボットの動作状況、エラー、AIの応答履歴など、詳細なログをファイルに出力します。これにより、問題の特定やデバッグが容易になります。
*   **ログファイルの自動管理**: ログファイルは日付ごとに自動でローテーションされ、一定期間経過した古いログは自動で削除されます。

### 8. おみくじ機能
*   **日替わりおみくじ**: メッセージに「おみくじ」と入力すると、毎日一度だけ引けるおみくじ機能です。AIが引いた運勢に合わせて、ラッキーカラー、ラッキーアイテム、そして今日1日のアドバイスを生成してくれます。

### 9. 管理者コマンド
*   **`/switch_model <モデル名>`**: ソフィアのAI思考モデルを動的に切り替えます。Gemini 2.5 Pro, Gemini 2.5 Flash, Gemini 1.5 Proなど、複数のモデルから選択可能です。
*   ボットの再起動、設定の動的な変更など、管理者向けのコマンドを提供します。

### 10. コンテキストメニュー
Discordのメッセージを右クリック（または長押し）することで利用できる便利な機能です。
*   **`このメッセージをAIで要約`**: メッセージの本文、添付画像、埋め込み、含まれるURL（Webページ、YouTube動画の字幕とサムネイル）をAIが総合的に分析し、要約します。Twitter/XのURLは技術的な制限により要約できません。
*   **`このメッセージを一番下に表示し続ける`**: 指定したメッセージをチャンネルの一番下に常に表示し続けます。新しいメッセージが投稿されるたびに、ボットがそのメッセージを再投稿することで実現します。解除するには、再度同じコマンドを実行します。
*   **`このメッセージを後で消す`**: 指定したメッセージを6時間、12時間、24時間後に自動で削除するように設定できます。メッセージの送信者本人、または「メッセージの管理」権限を持つユーザーのみが利用可能です。
*   **`メッセージを埋め込みにする`**: 通常のメッセージをDiscordの埋め込み形式に変換して再投稿します。視覚的に目立たせたい場合に便利です。
*   **`メッセージの文字数を数える`**: 選択したメッセージの文字数をカウントして表示します。

## 技術スタック
*   **言語**: Python
*   **Discordフレームワーク**: `discord.py`
*   **AI**: Google Gemini API (`google-generativeai`)
*   **HTTPクライアント**: `aiohttp`
*   **データベース**: `aiosqlite` (SQLite3)
*   **スマートホーム連携**: SwitchBot API
*   **その他**: `python-dotenv`, `pytube`, `ffmpeg` (音楽再生用)

## セットアップ方法

### 前提条件
*   Python 3.9+
*   pip (Pythonのパッケージインストーラ)
*   Git

### 1. リポジトリのクローン
まず、このリポジトリをローカルにクローンします。
```bash
git clone https://github.com/0rnot/Sophia.git
cd Sophia
```

### 2. 仮想環境の作成とアクティベート
プロジェクトの依存関係を分離するために、仮想環境の利用を強く推奨します。
```bash
python -m venv venv
# Windowsの場合
.\venv\Scripts\activate
# macOS/Linuxの場合
source venv/bin/activate
```

### 3. 依存関係のインストール
`requirements.txt` に記載されているすべての依存関係をインストールします。
```bash
pip install -r requirements.txt
```

### 4. 環境変数の設定
ボットの動作に必要なAPIキーやトークンを設定します。プロジェクトルートに `.env` ファイルを作成し、以下の形式で記述してください。
```
DISCORD_BOT_TOKEN="YOUR_DISCORD_BOT_TOKEN"
GOOGLE_API_KEY="YOUR_GOOGLE_GEMINI_API_KEY"
SWITCHBOT_TOKEN="YOUR_SWITCHBOT_TOKEN"
SWITCHBOT_SECRET="YOUR_SWITCHBOT_SECRET"
```
*   **DISCORD_BOT_TOKEN**: Discord Developer Portalで作成したボットのトークン。
*   **GOOGLE_API_KEY**: Google AI Studioで取得したGemini APIキー。
*   **SWITCHBOT_TOKEN**: SwitchBot開発者向けサイトで取得したトークン。
*   **SWITCHBOT_SECRET**: SwitchBot開発者向けサイトで取得したシークレット。

### 5. 設定ファイル (`config.py`) のカスタマイズ
`config.py` ファイルには、ボットの動作に関する様々な設定が含まれています。必要に応じて、以下の項目をカスタマイズしてください。

*   **`MONITOR_CHANNEL_ID`**: 環境監視通知を送信するDiscordチャンネルのID。
*   **`MONITOR_WEBHOOK_URL`**: 環境監視通知用のDiscord Webhook URL。
*   **`DEVICE_IDS`**: SwitchBotデバイスのIDと、それに対応するデバイスタイプ（例: `"co2_meter"`, `"plug_mini"`）のマッピング。
    ```python
    DEVICE_IDS = {
        "pc": "ED0EB8E342C1",
        "ac": "02-202310281308-28418244",
        "co2_meter": "B0E9FEA9A1A8",
        "plug_mini": "D83BDA17E832"
    }
    ```
*   **`THRESHOLDS`**: 温度、湿度、CO2、電力消費量に対する閾値設定。
    ```python
    THRESHOLDS = {
        "temperature": {"LL": 18.0, "L": 20.0, "H": 28.0, "HH": 30.0,},
        "humidity": {"LL": 20.0, "L": 30.0, "H": 60.0, "HH": 70.0,},
        "co2": {"LL": None, "L": None, "H": 1000, "HH": 1500,},
        "power": {"LL": None, "L": None, "H": 300.0, "HH": 500.0,}
    }
    ```
*   **`AI_PROMPT_TEMPLATE`**: 環境監視通知時にAIが応答するためのシステムプロンプト。
*   **`PROACTIVE_PROMPT_TEMPLATE`**: 自発会話機能で使用されるAIプロンプト。
*   **`NEWS_COMMENT_PROMPT_TEMPLATE`**: フィード監視機能でニュース記事にコメントする際に使用されるAIプロンプト。
*   **`DEFAULT_SOURCES`**: `sophia_feed_monitor_cog.py` で定義されているデフォルトのフィードソース。
    ```python
    DEFAULT_SOURCES = [
        {"name": "テクノロジー", "feed_url": "https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRWdvSUwyMHZNRGRqTVhZU0JXVnVMVWRDR2dKSlRpZ0FQAQ?hl=ja&gl=JP&ceid=JP:ja", "feed_type": "rss"},
        {"name": "AI", "feed_url": "https://news.google.com/rss/search?q=AI&hl=ja&gl=JP&ceid=JP:ja", "feed_type": "rss"},
        {"name": "PCハードウェア", "feed_url": "https://news.google.com/rss/search?q=PC%E3%83%8F%E3%83%BC%E3%83%89%E3%82%A6%E3%82%A7%E3%82%A2&hl=ja&gl=JP&ceid=JP:ja", "feed_type": "rss"},
        {"name": "PCゲーム", "feed_url": "https://news.google.com/rss/search?q=PC%E3%82%B2%E3%83%BC%E3%83%A0&hl=ja&gl=JP&ceid=JP:ja", "feed_type": "rss"},
    ]
    ```

## 実行方法

### ボットの起動
仮想環境がアクティベートされていることを確認し、以下のコマンドでボットを起動します。
```bash
python sophia_bot.py
```

### バックグラウンド実行 (推奨)
ボットを安定して稼働させるためには、バックグラウンドでの実行を推奨します。

*   **Linux/macOSの場合 (nohup)**:
    ```bash
    nohup python sophia_bot.py &
    ```
    これにより、ターミナルを閉じてもボットが動作し続けます。ログは `nohup.out` に出力されます。

*   **Windowsの場合 (PowerShellスクリプト)**:
    `restart_loop4.ps1` のようなPowerShellスクリプトを利用して、ボットを起動し、クラッシュ時に自動で再起動するように設定できます。スクリプトの内容を確認し、必要に応じてパスなどを調整してください。

## 利用方法

### 主要コマンド
Discordサーバー内で、以下のスラッシュコマンドを使用できます。

*   `/help`: ボットの機能とコマンド一覧を表示します。
*   `/join`: ソフィアがボイスチャンネルに参加します。
*   `/leave`: ソフィアがボイスチャンネルから退出します。
*   `/play [YouTube/Spotify URLまたは検索クエリ]`: YouTubeまたはSpotifyの音楽をボイスチャンネルで再生します。
*   `/interrupt [YouTube/Spotify URLまたは検索クエリ]`: 現在再生中の曲を停止し、指定した曲をキューの先頭に割り込ませて再生します。
*   `/play_random [テキストチャンネル]`: 指定したテキストチャンネルの履歴からランダムにURLを抽出し、音楽を再生します。
*   `/skip`: 現在再生中の曲をスキップします。
*   `/stop`: 再生を停止し、キューをクリアします。
*   `/pause`: 現在再生中の曲を一時停止します。
*   `/resume`: 一時停止中の曲を再開します。
*   `/loop`: 現在再生中の曲を無限ループします。
*   `/loop_queue`: キュー全体をループします。
*   `/clear`: 再生キューをクリアします（現在の曲は停止しません）。
*   `/queue`: 再生キューを表示します。
*   `/vlevel`: 自分のレベルと所持ゴールドを表示します。
*   `/vinventory`: 自分のインベントリを表示します。
*   `/vequip <インベントリID> `: 指定したIDのアイテムを装備します。
*   `/vstats`: 装備中のアイテムと合計ステータス（ATK/DEF）を表示します。
*   `/vreroll <インベントリID>`: 指定したIDのアイテムの効果を再抽選します（同じベースレアリティの装備5個を消費）。
*   `/vsell <インベントリID(スペース区切り)>`: 指定したIDのアイテムを売却します。
*   `/vbattle`: ランダムな敵と戦闘を開始します。
*   `/vgacha`: アイテムガチャを引きます。
*   `/hv meter`: SwitchBot温湿度計のデータを表示します。
*   `/hv plug`: SwitchBotプラグの電力使用状況を表示します。
*   `/q list`: 監視中のフィードソース一覧を表示します。
*   `/q add <名前> <フィードURL> <チャンネル> `: 新しいフィードソースを監視リストに追加します。
*   `/q remove <ソースID(スペース区切り)>`: 監視リストからソースを削除します。

*   `/switch_model <モデル名>`: AIの思考モデルを切り替えます。

### AIチャット
ボットが参加しているチャンネルで `@Sophia` とメンションするか、ボットのDMで話しかけることでAIチャットを開始できます。画像ファイルを添付して、画像認識機能を利用することも可能です。

### RPGの遊び方
`/rpg battle` コマンドで戦闘を開始し、敵を倒して経験値やアイテムを獲得します。レベルアップしてステータスを強化し、より強力な敵に挑戦しましょう。

## プロジェクト構造
```
Sophia/
├── config.py                 # ボットの各種設定ファイル
├── gacha_system.py           # ガチャシステム関連のロジック (RPGで使用)
├── kakuritu.html             # (おそらく開発用の確率計算HTMLファイル)
├── requirements.txt          # 依存関係のリスト
├── restart_loop4.ps1         # Windowsでのボット再起動用PowerShellスクリプト
├── RPG_cog.py                # RPG機能のDiscord Cog
├── rpg_data.py               # RPGのデータ定義 (アイテム、スキルなど)
├── rpg_utils.py              # RPGのユーティリティ関数
├── rpg_views.py              # RPGのUI要素 (ボタンなど)
├── sophia_admin_cog.py       # 管理者コマンドのDiscord Cog
├── sophia_audio_cog.py       # オーディオ機能のDiscord Cog
├── sophia_bot.py             # ボットのメインエントリポイント、AI連携ロジック
├── sophia_context_menu_cog.py # コンテキストメニュー機能のDiscord Cog
├── sophia_feed_monitor_cog.py # フィード監視機能のDiscord Cog (新着)
├── sophia_home_cog.py        # ホーム関連機能のDiscord Cog (未定義の場合あり)
├── sophia_logger_cog.py      # ロギング機能のDiscord Cog (新着)
├── sophia_monitor_cog.py     # 環境監視機能のDiscord Cog (SwitchBot連携)
├── sophia_omikuji_cog.py     # おみくじ機能のDiscord Cog (新着)
├── sophia_proactive_cog.py   # 自発会話機能のDiscord Cog
├── switchbot_api.py          # SwitchBot APIとの連携ロジック
├── __pycache__/              # Pythonのコンパイル済みバイトコード
├── .git/                     # Gitリポジトリ情報
└── enemy/                    # RPGの敵データ (JSONファイル)
    ├── enemy_ai_artisan.json
    ├── ... (その他の敵データファイル)
```

## 貢献方法
このプロジェクトへの貢献を歓迎します！バグ報告、機能提案、プルリクエストなど、お気軽にお寄せください。

## ライセンス
(ここにライセンス情報を記載してください。例: MIT License)

## 謝辞
*   Discord.py開発チーム
*   Google Gemini API開発チーム
*   SwitchBot開発チーム
*   その他、本プロジェクトに利用されているすべてのオープンソースプロジェクトとライブラリに感謝いたします。
